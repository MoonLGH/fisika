<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Pengereman V3 (Aerox & Investigasi)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --abs-color: #27ae60;
            --bg: #f4f6f7;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        
        /* Panel Control */
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: var(--primary); font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; color: #555; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        input:disabled { background: #eee; color: #999; }

        /* Tombol */
        .btn { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; margin-top: 10px; }
        .btn:hover { background: #34495e; transform: translateY(-1px); }

        /* Mode Investigasi Box */
        .investigation-box {
            background: #fff3cd; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #ffeeba; 
            margin-bottom: 15px;
        }
        .inv-title { font-weight:bold; color:#856404; margin-bottom:8px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }

        /* Hasil */
        .results-mini { margin-top: 20px; background: #fafafa; padding: 15px; border-radius: 6px; border-left: 4px solid var(--accent); }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .physics-val { color: var(--accent); font-weight: bold; }

        /* Canvas & Grafik */
        .canvas-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        #animCanvas { width: 100%; height: 220px; background: #555; border-radius: 4px; border-bottom: 4px dashed #fff; cursor: crosshair; }
        
        .charts-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        canvas.chart { background: #fff; border: 1px solid #eee; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="panel">
        <h2>‚öôÔ∏è Parameter Kendaraan</h2>

        <div class="investigation-box">
            <div class="inv-title">üïµÔ∏è Mode Investigasi</div>
            <div style="font-size: 0.85rem; margin-bottom: 8px; color: #856404;">
                <input type="checkbox" id="invMode" onchange="toggleMode()"> 
                <label for="invMode" style="display:inline; cursor:pointer;">Input berdasarkan Jarak</label>
            </div>
            
            <div class="input-group" id="targetDistGroup" style="display:none;">
                <label>Target Jarak Berhenti ($s_{target}$) [m]</label>
                <input type="number" id="targetDist" value="21.5" step="0.1">
            </div>
        </div>

        <div class="input-group">
            <label>Sistem Pengereman</label>
            <select id="brakeType">
                <option value="abs">‚úÖ ABS (Anti-lock Braking)</option>
                <option value="non">‚ùå Non-ABS (Rem Konvensional)</option>
            </select>
        </div>

        <div class="input-group">
            <label>Massa Total ($m$) [kg]</label>
            <input type="number" id="mass" value="195"> 
            <small style="color:gray; font-size:0.7em;">Contoh: Aerox (125kg) + Rider (70kg)</small>
        </div>

        <div class="input-group">
            <label>Kecepatan Awal ($v_0$) [m/s]</label>
            <input type="number" id="v0" value="8.33" step="0.01">
            <small style="color:gray; font-size:0.7em;">8.33 m/s ‚âà 30 km/jam</small>
        </div>

        <div class="input-group">
            <label>Perlambatan Rem ($a$) [m/s¬≤]</label>
            <input type="number" id="acc" value="-6" max="-0.1" step="0.1">
        </div>

        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px; background: #eef2f3; padding: 8px; border-radius: 4px;">
            <span>üåßÔ∏è Jalan Basah?</span>
            <input type="checkbox" id="wetMode" style="width: auto;">
        </div>

        <button class="btn" onclick="startSim()">üöÄ Jalankan Simulasi</button>

        <div class="results-mini">
            <div class="result-row">
                <span>Jarak Henti ($S$):</span>
                <span id="resDist" class="physics-val">0 m</span>
            </div>
            <div class="result-row">
                <span>Waktu Henti ($t$):</span>
                <span id="resTime" class="physics-val">0 s</span>
            </div>
            <div class="result-row">
                <span>Gaya Pengereman ($F$):</span>
                <span id="resForce" class="physics-val">0 N</span>
            </div>
        </div>
    </div>

    <div class="canvas-container">
        <h2>Visualisasi & Grafik</h2>
        <canvas id="animCanvas"></canvas>
        <div style="font-size:0.8rem; color:gray; margin-top:5px; text-align:right;">Visualisasi Skala Dinamis</div>

        <div class="charts-wrapper">
            <div><canvas id="chartVt" class="chart"></canvas></div>
            <div><canvas id="chartSt" class="chart"></canvas></div>
        </div>
    </div>
</div>

<script>
    // Inisialisasi Canvas Visualisasi
    const canvas = document.getElementById('animCanvas');
    const ctx = canvas.getContext('2d');
    
    // Set resolusi canvas agar tajam
    function resizeCanvas() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = 220;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); // Panggil sekali di awal

    let animId;
    let chartVtInst = null;
    let chartStInst = null;

    // Toggle Input untuk Mode Investigasi
    function toggleMode() {
        const isInv = document.getElementById('invMode').checked;
        const targetGroup = document.getElementById('targetDistGroup');
        const accInput = document.getElementById('acc');
        
        if (isInv) {
            targetGroup.style.display = 'block';
            accInput.disabled = true;  // Disable input perlambatan karena akan dihitung otomatis
            accInput.style.backgroundColor = "#eee";
        } else {
            targetGroup.style.display = 'none';
            accInput.disabled = false;
            accInput.style.backgroundColor = "white";
        }
    }

    // FUNGSI UTAMA: Mulai Simulasi
    function startSim() {
        // 1. Ambil Nilai dari Input
        let v0 = parseFloat(document.getElementById('v0').value);
        let mass = parseFloat(document.getElementById('mass').value);
        let brakeType = document.getElementById('brakeType').value;
        let isWet = document.getElementById('wetMode').checked;
        let isInv = document.getElementById('invMode').checked;
        let accInputDOM = document.getElementById('acc');

        // Validasi dasar
        if(v0 <= 0 || mass <= 0) { alert("Kecepatan dan Massa harus > 0"); return; }

        let a_calc; // Perlambatan yang akan digunakan untuk fisika

        // 2. LOGIKA FISIKA
        // Kasus A: Mode Investigasi (Diketahui Jarak -> Cari 'a')
        if (isInv) {
            let targetS = parseFloat(document.getElementById('targetDist').value);
            if(targetS <= 0) { alert("Target jarak harus > 0"); return; }
            
            // Rumus: a = -v^2 / 2s
            a_calc = -(v0 * v0) / (2 * targetS);
            
            // Tampilkan hasil hitungan ke input perlambatan (untuk info user)
            accInputDOM.value = a_calc.toFixed(3);
        
        // Kasus B: Mode Normal (Diketahui 'a' -> Cari Jarak)
        } else {
            let a_raw = parseFloat(accInputDOM.value);
            if(a_raw >= 0) a_raw = -a_raw; // Paksa negatif
            
            // Faktor Pengurang Performa
            let frictionFactor = 1.0;
            if (isWet) frictionFactor *= 0.6;          // Jalan basah: performa turun 40%
            if (brakeType === 'non') frictionFactor *= 0.75; // Non-ABS: selip, performa turun

            a_calc = a_raw * frictionFactor;
        }

        // 3. Hitung Hasil Akhir (Prediksi)
        let t_stop = -v0 / a_calc;
        let s_stop = -(v0 * v0) / (2 * a_calc);
        let force = Math.abs(mass * a_calc);

        // Update Teks Hasil
        document.getElementById('resDist').innerText = s_stop.toFixed(2) + " m";
        document.getElementById('resTime').innerText = t_stop.toFixed(2) + " s";
        document.getElementById('resForce').innerText = force.toFixed(0) + " N";

        // 4. SETUP ANIMASI
        if(animId) cancelAnimationFrame(animId);
        
        let t = 0;
        let dt = t_stop / 100; // Time step dinamis agar animasi mulus (~100 frames total)
        if (dt > 0.05) dt = 0.05; // Cap max dt biar gak patah-patah kalau durasi lama

        let currentS = 0;
        let currentV = v0;
        
        // Array untuk Grafik
        let dataT = [0], dataV = [v0], dataS = [0];

        // Skala Visual (Agar mobil tidak bablas keluar canvas)
        // Kita set lebar canvas = 1.2 x Jarak Henti Total
        let maxDistDisplay = s_stop * 1.2;
        if(maxDistDisplay < 10) maxDistDisplay = 10; // Min scale 10m
        let scale = canvas.width / maxDistDisplay;

        // Loop Animasi
        function animate() {
            if (currentV > 0.01) { // Stop jika v sangat kecil mendekati 0
                // Update Euler
                currentS += currentV * dt;
                currentV += a_calc * dt;
                t += dt;

                if (currentV < 0) currentV = 0; // Tidak boleh mundur

                // Simpan Data Grafik
                dataT.push(t.toFixed(2));
                dataV.push(currentV.toFixed(2));
                dataS.push(currentS.toFixed(2));

                renderFrame(currentS, scale, brakeType, isWet, isInv);
                animId = requestAnimationFrame(animate);
            } else {
                // Frame Terakhir (Mobil Berhenti)
                renderFrame(s_stop, scale, brakeType, isWet, isInv);
                updateCharts(dataT, dataV, dataS);
            }
        }
        animate();
    }

    // FUNGSI GAMBAR (CANVAS)
    function renderFrame(pos, scale, type, wet, invMode) {
        // 1. Bersihkan Layar
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 2. Gambar Jalan
        let roadColor = wet ? "#34495e" : "#555";
        ctx.fillStyle = roadColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Marka Jalan
        ctx.strokeStyle = "#fff";
        ctx.setLineDash([20, 20]);
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(0, 180);
        ctx.lineTo(canvas.width, 180);
        ctx.stroke();
        ctx.setLineDash([]); // Reset dash

        // 3. Efek Skid Marks (Jejak Ban)
        // Muncul jika Non-ABS ATAU (Investigasi aktif + Non-ABS dipilih)
        if (type === 'non') {
            ctx.fillStyle = "#1a1a1a";
            let xPos = pos * scale;
            if(xPos > canvas.width) xPos = canvas.width; // Clip
            
            // Jejak ban
            ctx.fillRect(0, 100, xPos, 8); // Ban Kiri
            ctx.fillRect(0, 140, xPos, 8); // Ban Kanan
        }

        // 4. Gambar Mobil
        let carX = pos * scale;
        // Mentok kanan canvas kalau jarak kejauhan (biar gak hilang)
        if (carX > canvas.width - 100) carX = canvas.width - 100;

        let carY = 80;
        
        // Body
        ctx.fillStyle = (type === 'abs') ? "#e74c3c" : "#c0392b"; // Merah terang (ABS), Merah gelap (Non)
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 10;
        ctx.fillRect(carX, carY, 80, 40);
        ctx.shadowBlur = 0; // Reset shadow

        // Kaca
        ctx.fillStyle = "#ecf0f1";
        ctx.fillRect(carX + 50, carY + 5, 20, 30);

        // Roda
        ctx.fillStyle = "#000";
        ctx.beginPath(); ctx.arc(carX + 20, carY + 40, 10, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(carX + 60, carY + 40, 10, 0, Math.PI*2); ctx.fill();

        // Teks Info di atas Mobil
        ctx.fillStyle = "#fff";
        ctx.font = "bold 14px Arial";
        ctx.fillText(pos.toFixed(1) + "m", carX + 15, carY - 10);

        // 5. Efek Hujan (Overlay)
        if (wet) {
            ctx.fillStyle = "rgba(255, 255, 255, 0.1)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#fff";
            ctx.font = "20px Arial";
            ctx.fillText("üåßÔ∏è", 20, 30);
        }
    }

    // FUNGSI UPDATE GRAFIK
    function updateCharts(labels, vData, sData) {
        // Hapus chart lama kalau ada
        if(chartVtInst) chartVtInst.destroy();
        if(chartStInst) chartStInst.destroy();

        // Chart Kecepatan (v-t)
        const ctxVt = document.getElementById('chartVt').getContext('2d');
        chartVtInst = new Chart(ctxVt, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Kecepatan (v) m/s',
                    data: vData,
                    borderColor: '#e74c3c',
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: { animation: false, scales: { x: { display: false } } }
        });

        // Chart Jarak (s-t)
        const ctxSt = document.getElementById('chartSt').getContext('2d');
        chartStInst = new Chart(ctxSt, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Jarak (s) meter',
                    data: sData,
                    borderColor: '#2980b9',
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: { animation: false }
        });
    }
</script>

</body>
</html>
